<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Finankox SPA</title>
  <link rel="icon" href="./pictures/icon_site.png">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined">
  <link rel="stylesheet" href="index.css">
</head>
<body>

  <nav class="nav_bar">
    <h1>Finankox</h1>
    <img src="./pictures/icon_site.png" class="logo">
    <ul>
      <li><a href="/"           data-navigo>Home</a></li>
      <li><a href="/searched/hi" data-navigo>Search “hi”</a></li>
      <li><a href="/about"      data-navigo>About</a></li>
    </ul>
    <a href="#" id="openBtn" class="burger">
      <span></span><span></span><span></span>
    </a>
    <div id="mySidenav" class="sidenav">
      <a href="#" id="closeBtn">×</a>
      <ul>
        <li><a href="/"           data-navigo>Home</a></li>
        <li><a href="/searched/ok" data-navigo>Search “ok”</a></li>
        <li><a href="/about"      data-navigo>About</a></li>
      </ul>
    </div>
  </nav>

  <!-- 1) zone crypto (Vue) -->
  <section id="crypto"></section>

  <!-- 2) zone de “view” (Navigo injecte ici) -->
  <section id="view"></section>

  <script type="module">
  // ----- IMPORTS -----
  import { createApp, ref, onMounted } from
    'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
  import Navigo from
    'https://unpkg.com/navigo@8.11.1/lib/navigo.es.min.js';

  // ----- ROUTER NAVIGO -----
  const view = document.getElementById('view');
  const router = new Navigo('/', { hash: false });

  function load(fragment, term = '') {
    fetch(fragment)
      .then(res => res.text())
      .then(html => {
        view.innerHTML = html;
        if (term) {
          const span = view.querySelector('[data-search-term]');
          if (span) span.textContent = decodeURIComponent(term);
        }
      });
  }

  router
    .on('/',                  () => load('home.html'))
    .on('/about',             () => load('about.html'))
    .on('/searched/:term+',   ({ data }) => load('search.html', data.term))
    .notFound(() => load('404.html'));
  router.resolve();

  document.body.addEventListener('click', e => {
    if (e.target.matches('[data-navigo]')) {
      e.preventDefault();
      router.navigate(e.target.getAttribute('href'));
    }
  });

  // ----- WIDGET CRYPTO (VUE) -----
  const CryptoApp = {
    setup() {
      const priceBTC  = ref(null);
      const priceETH  = ref(null);
      const priceSOL  = ref(null);
      const trendBTC  = ref('up');
      const trendETH  = ref('up');
      const trendSOL  = ref('up');
      const colorBTC  = ref('rgb(77,230,34)');
      const colorETH  = ref('rgb(77,230,34)');
      const colorSOL  = ref('rgb(77,230,34)');

      async function fetchPrice() {
        try {
          const [dB,dE,dS] = await Promise.all([
            fetch('https://api.exchange.coinbase.com/products/BTC-EUR/ticker').then(r=>r.json()),
            fetch('https://api.exchange.coinbase.com/products/ETH-EUR/ticker').then(r=>r.json()),
            fetch('https://api.exchange.coinbase.com/products/SOL-EUR/ticker').then(r=>r.json())
          ]);
          priceBTC.value = dB.price;
          priceETH.value = dE.price;
          priceSOL.value = dS.price;

          const [tB,tE,tS] = await Promise.all([
            fetch('https://api.exchange.coinbase.com/products/BTC-EUR/trades?limit=2').then(r=>r.json()),
            fetch('https://api.exchange.coinbase.com/products/ETH-EUR/trades?limit=2').then(r=>r.json()),
            fetch('https://api.exchange.coinbase.com/products/SOL-EUR/trades?limit=2').then(r=>r.json())
          ]);

          function applyTrend(trades, trend, color) {
            if (trades[0].price>trades[1].price) {
              trend.value='up';    color.value='rgb(77,230,34)';
            } else if (trades[0].price<trades[1].price) {
              trend.value='down';  color.value='rgb(216,16,16)';
            }
          }
          applyTrend(tB, trendBTC, colorBTC);
          applyTrend(tE, trendETH, colorETH);
          applyTrend(tS, trendSOL, colorSOL);
        }
        catch(err){ console.error(err); }
      }

      onMounted(()=>{
        fetchPrice();
        setInterval(fetchPrice,1000);
      });

      return { priceBTC, priceETH, priceSOL,
               trendBTC, trendETH, trendSOL,
               colorBTC, colorETH, colorSOL };
    },
    template: `
      <div class="prices">
        <p v-if="priceBTC">1 BTC = {{Intl.NumberFormat('us-US').format(priceBTC)}} €
          <span class="material-symbols-outlined"
                :class="trendBTC"
                :style="{color: colorBTC}">
            {{ trendBTC==='up'? 'arrow_drop_up':'arrow_drop_down' }}
          </span>
        </p>
        <p v-if="priceETH">1 ETH = {{Intl.NumberFormat('us-US').format(priceETH)}} €
          <span class="material-symbols-outlined"
                :class="trendETH"
                :style="{color: colorETH}">
            {{ trendETH==='up'? 'arrow_drop_up':'arrow_drop_down' }}
          </span>
        </p>
        <p v-if="priceSOL">1 SOL = {{Intl.NumberFormat('us-US').format(priceSOL)}} €
          <span class="material-symbols-outlined"
                :class="trendSOL"
                :style="{color: colorSOL}">
            {{ trendSOL==='up'? 'arrow_drop_up':'arrow_drop_down' }}
          </span>
        </p>
      </div>
    `
  };

  createApp(CryptoApp).mount('#crypto');
  </script>

  <script>
    // burger menu (pas besoin de module)
    const sidenav = document.getElementById("mySidenav");
    document.getElementById("openBtn").onclick  =
      () => sidenav.classList.add("active");
    document.getElementById("closeBtn").onclick =
      () => sidenav.classList.remove("active");
  </script>

</body>
</html>